import logging
from datetime import datetime
from zoneinfo import ZoneInfo

from aiogram import F, Router
from aiogram.types import CallbackQuery
from aiogram.fsm.context import FSMContext

from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

from app.database.models import User, MessageSchedule
from app.database.crud_user import get_user_by_id
from app.database.crud_admin import add_message_schedule
from app.kbds.kbds import InlineKeyboards, ReplyKeyboards

logger = logging.getLogger(__name__)
challenge_router = Router()

# =============================================================================
# –î–ê–¢–´ –ß–ï–õ–õ–ï–ù–î–ñ–ê
# =============================================================================
CHALLENGE_DATES = {
    "day2_morning": datetime(2025, 11, 11, 10, 0, tzinfo=ZoneInfo("Asia/Almaty")),
    "day2_afternoon": datetime(2025, 11, 11, 13, 0, tzinfo=ZoneInfo("Asia/Almaty")),
    "day3_morning": datetime(2025, 11, 12, 10, 0, tzinfo=ZoneInfo("Asia/Almaty")),
    "day3_afternoon": datetime(2025, 11, 12, 13, 0, tzinfo=ZoneInfo("Asia/Almaty")),
    "final": datetime(2025, 11, 13, 13, 0, tzinfo=ZoneInfo("Asia/Almaty")),
}

REGISTRATION_START = datetime(2025, 11, 7, 0, 0, tzinfo=ZoneInfo("Asia/Almaty"))
COURSE_LINK = "https://www.nutrikaz.kz/#rec1462578793"
CHAT_LINK = "https://t.me/nutrikaz"

# =============================================================================
# –°–û–û–ë–©–ï–ù–ò–Ø
# =============================================================================
MESSAGES = {
    "day2_morning": (
        "üç´ –î–µ–Ω—å 2. ¬´–ï–º, –Ω–µ –Ω–∞–∫–∞–∑—ã–≤–∞—é¬ª\n\n"
        "–ù–∞—à –º–∏–Ω–∏-—á–µ–ª–ª–µ–Ω–¥–∂ ¬´3 –¥–Ω—è –¥–ª—è —Ç–µ–±—è –∏ —Ç–≤–æ–µ–≥–æ —Ç–µ–ª–∞¬ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è! –ù–æ —Ç—ã –µ—â—ë —É—Å–ø–µ–≤–∞–µ—à—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è!\n\n"
        "üí≠ –ê —Ç–µ–ø–µ—Ä—å –¥–∞–≤–∞–π —á–µ—Å—Ç–Ω–æ: —Ç—è–Ω–µ—Ç –Ω–∞ —Å–ª–∞–¥–∫–æ–µ?\n\n"
        "–≠—Ç–æ –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å ‚Äî —Ç—ã —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–µ–±–µ –∑–∞–ø—Ä–µ—â–∞–µ—à—å!\n"
        "–•–æ—á–µ—à—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, –∫–∞–∫ —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Å–µ–±–µ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ –∏ –ø–µ—Ä–µ—Å—Ç–∞—Ç—å —Å—Ä—ã–≤–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Ñ–µ—Ç—ã?\n\n"
        f"–ñ–º–∏üëá\n<a href='{CHAT_LINK}'>–ß–∞—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</a>"
    ),

    "day2_afternoon": (
        "ü•ó –î–µ–Ω—å 2. –ï–º, –Ω–µ –Ω–∞–∫–∞–∑—ã–≤–∞—é\n\n"
        "–ù–∞—à –º–∏–Ω–∏-—á–µ–ª–ª–µ–Ω–¥–∂ ¬´3 –¥–Ω—è –¥–ª—è —Ç–µ–±—è –∏ —Ç–≤–æ–µ–≥–æ —Ç–µ–ª–∞¬ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è! –¢—ã –≤—Å—ë –µ—â—ë —É—Å–ø–µ–≤–∞–µ—à—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è!\n\n"
        "–î—É–º–∞–µ—à—å, –ø–µ—Ä–µ–∫—É—Å—ã ‚Äî —ç—Ç–æ –≤—Ä–µ–¥–Ω–æ?\n\n"
        "–ê —á—Ç–æ, –µ—Å–ª–∏ –º—ã —Å–∫–∞–∂–µ–º, —á—Ç–æ –ø–µ—Ä–µ–∫—É—Å—ã –≤–∞–∂–Ω—ã –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –≤–µ—Å–∞?!\n"
        "–•–æ—á–µ—à—å –Ω–∞—É—á–∏—Ç—å—Å—è —Å–æ–±–∏—Ä–∞—Ç—å –ø–æ–ª–µ–∑–Ω—ã–µ –∏ –≤–∫—É—Å–Ω—ã–µ –ø–µ—Ä–µ–∫—É—Å—ã? –ê –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ —É–∂–∏–Ω—ã –∑–∞ 10 –º–∏–Ω—É—Ç?\n\n"
        f"–ñ–º–∏üëá\n<a href='{CHAT_LINK}'>–ß–∞—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</a>"
    ),

    "day3_morning": (
        "ü•Ñ –î–µ–Ω—å 3. –ü–ª–∞–Ω ¬´–ë¬ª\n\n"
        "–ù–∞—à –º–∏–Ω–∏-—á–µ–ª–ª–µ–Ω–¥–∂ ¬´3 –¥–Ω—è –¥–ª—è —Ç–µ–±—è –∏ —Ç–≤–æ–µ–≥–æ —Ç–µ–ª–∞¬ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è! –£—Å–ø–µ–π –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞–≥–æ–Ω!\n\n"
        "üí≠ –û—Ç–≤–µ—Ç—å —á–µ—Å—Ç–Ω–æ: —Ü–µ–ª—ã–π –¥–µ–Ω—å —Ç–æ –∫–æ—Ñ–µ, —Ç–æ –ø–µ—á–µ–Ω—å–µ, —Ç–æ —è–±–ª–æ–∫–æ, –∞ –∑–∞ —É–∂–∏–Ω–æ–º –Ω–µ –º–æ–∂–µ—à—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è?\n\n"
        "–¢—ã –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≥–æ–ª–æ–¥–Ω–∞!\n\n"
        "‚ú® –°–µ–≥–æ–¥–Ω—è –º—ã —Ä–∞–∑–±–∏—Ä–∞–µ–º—Å—è, –∫–∞–∫ —Å–æ–±—Ä–∞—Ç—å ¬´–∑–¥–æ—Ä–æ–≤—É—é¬ª —Ç–∞—Ä–µ–ª–∫—É –∑–∞ 10 –º–∏–Ω—É—Ç ‚Äî –±–µ–∑ –ª–∏—à–Ω–µ–π —Å—É–µ—Ç—ã –∏ —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º.\n\n"
        "–•–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å, –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏—Ü—ã —Ä–µ—à–∞—é—Ç –≤–µ—á–Ω—É—é –¥–∏–ª–µ–º–º—É ¬´–ø–µ—Ä–µ–∫—É—Å–∏—Ç—å –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∞—Ç—å —É–∂–∏–Ω–∞¬ª?\n\n"
        f"–¢–æ–≥–¥–∞ –∑–∞–≥–ª—è–Ω–∏ –≤ —á–∞—Çüëá\n<a href='{CHAT_LINK}'>–ß–∞—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</a>"
    ),

    "day3_afternoon": (
        "üå∏ –í–æ—Ç –∏ —Ñ–∏–Ω–∞–ª –Ω–∞—à–µ–≥–æ –º–∏–Ω–∏-—á–µ–ª–ª–µ–Ω–¥–∂–∞ ¬´3 –¥–Ω—è –¥–ª—è —Ç–µ–±—è –∏ —Ç–≤–æ–µ–≥–æ —Ç–µ–ª–∞¬ª.\n\n"
        "–¢—Ä–∏ –¥–Ω—è ‚Äî –≤—Ä–æ–¥–µ –±—ã –Ω–µ–º–Ω–æ–≥–æ, –Ω–æ —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω—ã: –ª—ë–≥–∫–æ—Å—Ç—å, —ç–Ω–µ—Ä–≥–∏—é –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –±–æ–ª—å—à–µ.\n\n"
        "üíõ –≠—Ç–∏ —Ç—Ä–∏ –¥–Ω—è ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ.\n"
        "–î–∞–ª—å—à–µ ‚Äî —Å–∞–º–æ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ: –∫–∞–∫ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –≤ —É—Å—Ç–æ–π—á–∏–≤—É—é —Å–∏—Å—Ç–µ–º—É –ø–∏—Ç–∞–Ω–∏—è, –±–µ–∑ –æ—Ç–∫–∞—Ç–æ–≤ –∏ —á—É–≤—Å—Ç–≤–∞ –≤–∏–Ω—ã.\n\n"
        "üì£ –ü–æ—ç—Ç–æ–º—É –ø—Ä–∏–≥–ª–∞—à–∞–µ–º —Ç–µ–±—è –≤ –Ω–∞—à—É –ø—Ä–æ–≥—Ä–∞–º–º—É ¬´–ù–∞—É–∫–∞ —Ç–µ–ª–∞¬ª, –≥–¥–µ —Ç—ã:\n"
        "‚Ä¢ —É–∑–Ω–∞–µ—à—å, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∑–¥–æ—Ä–æ–≤—ã–π —Ä–∞—Ü–∏–æ–Ω –¥–ª—è —Å–µ–±—è –∏ –≤—Å–µ–π —Å–µ–º—å–∏;\n"
        "‚Ä¢ –ø–æ–π–º—ë—à—å, –ø–æ—á–µ–º—É —Ç—ã –ø–µ—Ä–µ–µ–¥–∞–µ—à—å –∏ —Å—Ä—ã–≤–∞–µ—à—å—Å—è, –∏ –∫–∞–∫ –≤–µ—Ä–Ω—É—Ç—å —Å–µ–±—è –≤ –∑–¥–æ—Ä–æ–≤—É—é —Ä—É—Ç–∏–Ω—É;\n"
        "‚Ä¢ –Ω–∞—É—á–∏—à—å—Å—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å, –¥–µ–ª–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ –∑–∞–≥–æ—Ç–æ–≤–∫–∏ –∏ —á–∏—Ç–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤;\n"
        "‚Ä¢ —Ä–∞–∑–±–µ—Ä—ë—à—å—Å—è, –∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∂–∏–∑–Ω—å —Å–ø–æ—Ä—Ç, —É–ª—É—á—à–∏—Ç—å —Å–æ–Ω –∏ –ø–æ–Ω–∏–º–∞—Ç—å —Å–≤–æ–∏ —ç–º–æ—Ü–∏–∏.\n\n"
        "‚ú® –ï—Å–ª–∏ —Ç–µ–±–µ –æ—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å —ç—Ç–∏ —Ç—Ä–∏ –¥–Ω—è ‚Äî –∑–Ω–∞—á–∏—Ç, —Ç—ã —É–∂–µ –≥–æ—Ç–æ–≤–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Ä–æ–≤–Ω—é –∑–∞–±–æ—Ç—ã –æ —Å–µ–±–µ.\n\n"
        f"‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ø—Ä–æ–≥—Ä–∞–º–º–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ñ–∏–≥—É—Ä—É –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫ –ù–æ–≤–æ–º—É –≥–æ–¥—É üí´\n"
        f"<a href='{COURSE_LINK}'>–ö—É–ø–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É</a>"
    ),

    "final": (
        "‚ú® –ü—Ä–∏—Å–ª—É—à–∞–π—Å—è ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –ø—Ä–æ —Ç–µ–±—è:\n\n"
        "‚úîÔ∏è –º–Ω–æ–≥–æ —Ä–∞–∑ –ø—Ä–æ–±–æ–≤–∞–ª–∞ —Ö—É–¥–µ—Ç—å, –Ω–æ –≤–µ—Å –≤–æ–∑–≤—Ä–∞—â–∞–ª—Å—è;\n"
        "‚úîÔ∏è –Ω–µ –∑–Ω–∞–µ—à—å, —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å, –∏ –≤—Å—ë –≤—Ä–µ–º—è –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—à—å;\n"
        "‚úîÔ∏è —á–∞—Å—Ç–æ —Ç—è–Ω–µ—Ç –Ω–∞ —Å–ª–∞–¥–∫–æ–µ, –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ –≤–µ—á–µ—Ä–∞–º;\n"
        "‚úîÔ∏è –Ω–µ —Ö–æ—á–µ—à—å –æ—Ç–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –æ—Ç –ª—é–±–∏–º—ã—Ö –±–ª—é–¥;\n"
        "‚úîÔ∏è –±–æ–∏—à—å—Å—è, —á—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ ‚Äî —ç—Ç–æ —Å–ª–æ–∂–Ω–æ –∏ –¥–æ—Ä–æ–≥–æ;\n"
        "‚úîÔ∏è –¥—É–º–∞–µ—à—å, —á—Ç–æ –±–µ–∑ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–π–¥–µ—Ç;\n"
        "‚úîÔ∏è –Ω–µ —Ö–æ—á–µ—à—å –≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è —Å–µ–±—è –∏ —Å–µ–º—å–∏.\n\n"
        "‚ÅâÔ∏è –ï—Å–ª–∏ —É–∑–Ω–∞–ª–∞ —Å–µ–±—è —Ö–æ—Ç—è –±—ã –≤ –æ–¥–Ω–æ–º –∏–∑ –ø—É–Ω–∫—Ç–æ–≤ ‚Äî —ç—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç–µ–±–µ –ø–æ–¥–æ–π–¥—ë—Ç.\n"
        "–û–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –ø—É—Ç—å –∫ —Å—Ç—Ä–æ–π–Ω–æ—Å—Ç–∏ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Å—Ç—ã–º, –≤–∫—É—Å–Ω—ã–º –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º!\n\n"
        f"‚û°Ô∏è –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –ø—Ä–æ–≥—Ä–∞–º–º–µ ¬´–ù–∞—É–∫–∞ —Ç–µ–ª–∞¬ª –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∏–∂–µ ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤—å —Ñ–∏–≥—É—Ä—É –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫ –ù–æ–≤–æ–º—É –≥–æ–¥—É üí´\n"
        f"<a href='{COURSE_LINK}'>–ö—É–ø–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É</a>\n\n"
        "–ü–æ—Ä–∞ –ª—é–±–∏—Ç—å —Å–µ–±—è –∏ —Å–≤–æ—ë —Ç–µ–ª–æ –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É üíõ"
    ),
}

# =============================================================================
# –§–£–ù–ö–¶–ò–Ø: –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π 
# =============================================================================
async def register_challenge(session: AsyncSession, user: User):
    """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞. –î—É–±–ª–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è."""
    try:
        for key, scheduled_dt in CHALLENGE_DATES.items():
            send_time_naive = scheduled_dt.replace(tzinfo=None)

            exists = await session.execute(
                select(MessageSchedule).where(
                    MessageSchedule.user_id == user.id,
                    MessageSchedule.send_time == send_time_naive
                )
            )
            if exists.scalar_one_or_none():
                logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ {scheduled_dt} —É–∂–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è {user.user_id}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                continue

            await add_message_schedule(
                session=session,
                user_id=user.id,
                message_text=MESSAGES[key],
                scheduled_at=scheduled_dt  
            )
            logger.info(f"–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ '{key}' –Ω–∞ {scheduled_dt} –¥–ª—è {user.user_id}")

        await session.commit()
        logger.info(f"–í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è {user.user_id}")

    except Exception as e:
        await session.rollback()
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —á–µ–ª–ª–µ–Ω–¥–∂–∞ –¥–ª—è {user.user_id}: {e}", exc_info=True)


# =============================================================================
# –•–ï–ù–î–õ–ï–†: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —á–µ–ª–ª–µ–Ω–¥–∂
# =============================================================================
@challenge_router.callback_query(F.data == "join_challenge")
async def challenge_registration(callback: CallbackQuery, session: AsyncSession, state: FSMContext):
    user = await get_user_by_id(session, callback.from_user.id)
    if not user:
        await callback.answer("–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return

    now = datetime.now(ZoneInfo("Asia/Almaty"))

    if now < REGISTRATION_START:
        await callback.message.answer(
            f"<b>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫—Ä–æ–µ—Ç—Å—è:</b>\n"
            f"{REGISTRATION_START.strftime('%d.%m.%Y %H:%M')}\n\n"
            "–û–∂–∏–¥–∞–π—Ç–µ!",
            reply_markup=ReplyKeyboards.back_to_menu()
        )
        await callback.answer()
        return

    await callback.message.answer(
        MESSAGES["day1_morning"],
        parse_mode="HTML",
        disable_web_page_preview=True,
        reply_markup=InlineKeyboards.challenge_menu()
    )

    await register_challenge(session, user)

    await callback.answer("–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —á–µ–ª–ª–µ–Ω–¥–∂!")


# =============================================================================
# –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –•–ï–ù–î–õ–ï–†–û–í
# =============================================================================
def register_challenge_handlers(router: Router):
    router.include_router(challenge_router)
    return router