import logging
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo

from aiogram import F, Router
from aiogram.types import CallbackQuery
from aiogram.fsm.context import FSMContext

from sqlalchemy.ext.asyncio import AsyncSession

from app.database.models import User
from app.database.crud_user import get_user_by_id
from app.database.crud_admin import add_message_schedule, assign_user_to_lead_source
from app.kbds.kbds import InlineKeyboards

logger = logging.getLogger(__name__)
webinar_router = Router()

# =============================================================================
# –≠–¢–ê–ü 1 ‚Äî –ü–ï–†–í–´–ô –í–•–û–î (—Ç–æ–ª—å–∫–æ –≤–µ–±–∏–Ω–∞—Ä)
# =============================================================================
WEBINAR_DATETIME = datetime(2025, 11, 6, 18, 30, tzinfo=ZoneInfo("Asia/Almaty"))
STREAM_LINK = "https://us06web.zoom.us/j/85077064347?pwd=5vFY3r8BVcYMsb8pLtEQJgPOFrLZwn.1"
RECORD_LINK = "https://drive.google.com/drive/folders/1M6hjnEfcaZMjCWuSOX1SITAvzHjheY7p"
COURSE_LINK = "https://www.nutrikaz.kz/#rec1462578793"

# =============================================================================
# –¢–ï–ö–°–¢–´ –í–ï–ë–ò–ù–ê–†–ê ‚Äî –¢–û–õ–¨–ö–û –¢–ï–ö–°–¢
# =============================================================================
WEBINAR_TEXTS = {
    "welcome_after_reg": (
        "üéØ <b>–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä!</b>\n\n"
        "üìÖ –¢–µ–º–∞: <i>¬´–ü–æ—á–µ–º—É –≤–µ—Å –Ω–µ —É—Ö–æ–¥–∏—Ç: 3 –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã¬ª</i>\n"
        "üïñ –≠—Ñ–∏—Ä —Å–æ—Å—Ç–æ–∏—Ç—Å—è <b>6 –Ω–æ—è–±—Ä—è –≤ 18:30 (–ê–ª–º–∞—Ç—ã)</b>\n\n"
        "üí° <b>–û —á–µ–º –±—É–¥–µ—Ç –≤–µ–±–∏–Ω–∞—Ä:</b>\n"
        "‚Ä¢ –ò–∑–±—ã—Ç–æ—á–Ω—ã–π –≤–µ—Å –∏ —É—Å–∏–ª–∏—è: –Ω–µ—Ä–∞–≤–Ω–∞—è –±–æ—Ä—å–±–∞\n"
        "‚Ä¢ –ù–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –≤—ã —Ç–µ—Ä–ø–∏—Ç–µ –Ω–µ—É–¥–∞—á—É\n"
        "‚Ä¢ –ò —á—Ç–æ —Å –Ω–∏–º–∏ –¥–µ–ª–∞—Ç—å\n"
        "‚Ä¢ –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã ¬´–ù–∞—É–∫–∞ —Ç–µ–ª–∞¬ª –∏ —Å—é—Ä–ø—Ä–∏–∑ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n"
        "‚Ä¢ –í–∞–∂–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏–≤–µ–¥–µ—Ç –≤–∞—Å –∫ —Ü–µ–ª–∏\n\n"
        "üì≤ –ù–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ ‚Äî –±–æ—Ç –Ω–∞–ø–æ–º–Ω–∏—Ç:\n"
        "‚Ä¢ –£—Ç—Ä–æ–º –≤ –¥–µ–Ω—å —ç—Ñ–∏—Ä–∞\n"
        "‚Ä¢ –ó–∞ 1 —á–∞—Å –¥–æ –Ω–∞—á–∞–ª–∞"
    ),
    "morning": (
        "‚òÄÔ∏è <b>–°–µ–≥–æ–¥–Ω—è –≤—Å—Ç—Ä–µ—á–∞–µ–º—Å—è –≤ 18:30!</b>\n\n"
        "üí° <b>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å:</b>\n"
        "‚Ä¢ –í–æ–¥—É, —á–∞–π, –∫–æ—Ñ–µ –∏–ª–∏ –¥—Ä—É–≥–æ–π –±–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π –Ω–∞–ø–∏—Ç–æ–∫\n"
        "‚Ä¢ –ë–ª–æ–∫–Ω–æ—Ç –∏ —Ä—É—á–∫—É\n"
        "‚Ä¢ –•–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ\n\n"
        "‚è≥ –°–ª–µ–¥—É—é—â–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ ‚Äî –∑–∞ 1 —á–∞—Å"
    ),
    "hour_before": (
        "üö® <b>–í–µ–±–∏–Ω–∞—Ä —Å—Ç–∞—Ä—Ç—É–µ—Ç —á–µ—Ä–µ–∑ 1 —á–∞—Å!</b>\n\n"
        "üìÖ –¢–µ–º–∞: ¬´–ü–æ—á–µ–º—É –≤–µ—Å –Ω–µ —É—Ö–æ–¥–∏—Ç: 3 –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã¬ª\n"
        f"üïï –ù–∞—á–∞–ª–æ –≤ 18:30 ‚Äî <a href='{STREAM_LINK}'>–í–æ–π—Ç–∏ –≤ —ç—Ñ–∏—Ä</a>\n\n"
        "üí° <b>–û —á–µ–º –±—É–¥–µ—Ç –≤–µ–±–∏–Ω–∞—Ä:</b>\n"
        "‚Ä¢ –ò–∑–±—ã—Ç–æ—á–Ω—ã–π –≤–µ—Å –∏ —É—Å–∏–ª–∏—è: –Ω–µ—Ä–∞–≤–Ω–∞—è –±–æ—Ä—å–±–∞\n"
        "‚Ä¢ –ù–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –≤—ã —Ç–µ—Ä–ø–∏—Ç–µ –Ω–µ—É–¥–∞—á—É\n"
        "‚Ä¢ –ò —á—Ç–æ —Å –Ω–∏–º–∏ –¥–µ–ª–∞—Ç—å\n"
        "‚Ä¢ –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã ¬´–ù–∞—É–∫–∞ —Ç–µ–ª–∞¬ª –∏ —Å—é—Ä–ø—Ä–∏–∑ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n"
        "‚Ä¢ –í–∞–∂–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏–≤–µ–¥–µ—Ç –≤–∞—Å –∫ —Ü–µ–ª–∏"
    ),
    "after": (
        "üíõ <b>–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ–±–æ–ª—å—à–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã ‚Äî –∏ –±–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –≤–∞—à–µ —Ç–µ—Ä–ø–µ–Ω–∏–µ –∏ —É—á–∞—Å—Ç–∏–µ üåø</b>\n\n"
        "–ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ –≥–æ—Ç–æ–≤–∞ –∑–∞–ø–∏—Å—å –≤–µ–±–∏–Ω–∞—Ä–∞!\n"
        "–°–º–æ—Ç—Ä–∏—Ç–µ –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∏–∂–µ üëá\n\n"
        "üé• <b><a href='https://us06web.zoom.us/rec/share/6pRYoxUqUS_k6OfWOJoDHh7QclKO0V1ZMXBlobPJkYDTBuWJ38tP-DuOuG0DvtOm.nk_RgRM2cg4Cs8MQ'>–°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤–µ–±–∏–Ω–∞—Ä–∞</a></b>\n"
        "üîë <b>–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞:</b> L=hs=1Ab\n\n"
        "–ê –µ—â—ë —É –Ω–∞—Å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ üéÅ\n"
        "–ü—Ä—è–º–æ –≤–æ –≤—Ä–µ–º—è —ç—Ñ–∏—Ä–∞ –ú–∞—Ä–∏–Ω–∞ –¢—ë –ø—Ä–∏–¥—É–º–∞–ª–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–Ω—É—Å:\n"
        "‚ú® <b>¬´–°–∞–º–æ–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ: –∫–∞–∫ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–∑–≥ –Ω–∞ —Å—Ç—Ä–æ–π–Ω–æ—Å—Ç—å¬ª</b>\n\n"
        "–≠—Ç–æ—Ç –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏—Ü –≤–µ–±–∏–Ω–∞—Ä–∞, –æ–ø–ª–∞—Ç–∏–≤—à–∏—Ö –ª—é–±–æ–π —Ç–∞—Ä–∏—Ñ –ø—Ä–æ–≥—Ä–∞–º–º—ã ¬´–ù–∞—É–∫–∞ —Ç–µ–ª–∞¬ª.\n\n"
        "‚è≥ <b>–ó–∞–ø–∏—Å—å –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∏—Ç—å —Å–∫–∏–¥–∫—É 10% ‚Äî —Ç–æ–ª—å–∫–æ 48 —á–∞—Å–æ–≤!</b>\n\n"
        f"üëá <a href='{COURSE_LINK}'>–ö—É–ø–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –∏ –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å</a>"
    )
}

# =============================================================================
# –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô
# =============================================================================
async def schedule_webinar_reminders(session: AsyncSession, user: User, state: FSMContext):
    """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç 3 —Å–æ–æ–±—â–µ–Ω–∏—è: —É—Ç—Ä–æ–º, –∑–∞ —á–∞—Å, –ø–æ—Å–ª–µ –≤–µ–±–∏–Ω–∞—Ä–∞."""
    try:
        now = datetime.now(ZoneInfo("Asia/Almaty"))

        reminders = [
            # –£—Ç—Ä–æ–º
            (WEBINAR_DATETIME.replace(hour=10, minute=0, second=0, microsecond=0), "morning"),
            # –ó–∞ 1 —á–∞—Å
            (WEBINAR_DATETIME - timedelta(hours=1), "hour_before"),
            # –ü–æ—Å–ª–µ ‚Äî –ø–æ–ª–Ω–∞—è –¥–∞—Ç–∞ 06.11.2025 20:50
            (datetime(2025, 11, 6, 20, 56, tzinfo=ZoneInfo("Asia/Almaty")), "after"),
        ]

        for scheduled_at, text_key in reminders:
            if scheduled_at > now:
                text = WEBINAR_TEXTS.get(text_key, f"[–û–®–ò–ë–ö–ê: –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞ {text_key}]")
                await add_message_schedule(
                    session=session,
                    user_id=user.id,
                    message_text=text,
                    scheduled_at=scheduled_at
                )

        await session.commit()
        logger.info(f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –≤–µ–±–∏–Ω–∞—Ä–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã: user {user.id}")

    except Exception as e:
        await session.rollback()
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}")
        raise

# =============================================================================
# –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ù–ê –í–ï–ë–ò–ù–ê–†
# =============================================================================
@webinar_router.callback_query(F.data == "want_participate")
async def webinar_registration(callback: CallbackQuery, session: AsyncSession, state: FSMContext):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä."""
    user = await get_user_by_id(session, callback.from_user.id)
    if not user:
        await callback.answer("–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    await assign_user_to_lead_source(session, user.user_id, "webinar")
    await session.commit()

    await callback.message.answer(
        WEBINAR_TEXTS["welcome_after_reg"],
        parse_mode="HTML",
        reply_markup=InlineKeyboards.post_webinar_keyboard(after_webinar=False)
    )

    await schedule_webinar_reminders(session, user, state)
    await callback.answer("–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä!")
